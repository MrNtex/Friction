name: Deploy with Version Bump

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Increment Version
        run: |
          node -e "
            const fs = require('fs');
            const manifest = require('./manifest.json');
            const parts = manifest.version.split('.').map(Number);
            parts[parts.length - 1]++;
            manifest.version = parts.join('.');
            fs.writeFileSync('./manifest.json', JSON.stringify(manifest, null, 2));
            console.log('Version bumped to ' + manifest.version);
          "
      - name: Commit and Push Version Bump
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add manifest.json
          git commit -m "Auto-bump version [skip ci]"
          git push
      - name: Zip extension
        run: zip -r extension.zip . -x "*.git*" ".github*"
      - name: Upload to Chrome Web Store
        uses: mobilefirstllc/webstore-upload-action@v2
        with:
          file: extension.zip
          extension_id: ${{ secrets.CHROME_EXTENSION_ID }}
          client_id: ${{ secrets.CHROME_CLIENT_ID }}
          client_secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh_token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: false # just draft upload